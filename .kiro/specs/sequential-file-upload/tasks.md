# Implementation Plan

## 概要

順次ファイルアップロード機能を既存のClean-liteアーキテクチャに統合し、後方互換性を維持しながら新しいAPIエンドポイントとUI機能を追加する。

## 実装タスク

- [x] 1. ドメイン層拡張の実装
- [x] 1.1 AddSubmissionFileユースケースの実装
  - 既存submissionへの単一ファイル追加機能を実装
  - ファイルサイズ・拡張子・パストラバーサルの検証処理を追加
  - ファイル保存とメタデータ更新のアトミック処理を実装
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8_

- [x] 1.2 GetSubmissionFilesユースケースの実装
  - submissionのファイル一覧取得機能を実装
  - ユーザー認証と権限チェックを追加
  - ファイルメタデータ（サイズ・アップロード日時）の返却処理を実装
  - _Requirements: 8.1, 8.2, 8.3, 8.4_

- [x] 1.3 EnqueueJobユースケースの拡張
  - ジョブ投入前のentrypoint・config_file存在確認を追加
  - 既存のレート制限・ジョブ投入ロジックを維持
  - エラーメッセージの改善と完全性検証結果の返却を実装
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 2. ポート層拡張の実装
- [x] 2.1 StoragePortインタフェースの拡張
  - add_fileメソッドとlist_filesメソッドを追加
  - 既存のsave・load・existsメソッドとの整合性を確保
  - インタフェースの型安全性を維持
  - _Requirements: 1.1, 8.1_

- [x] 3. アダプタ層拡張の実装
- [x] 3.1 FileSystemStorageAdapterの拡張
  - add_fileメソッドの実装（ファイル保存とメタデータ更新）
  - list_filesメソッドの実装（ファイル一覧とメタデータの取得）
  - 既存の実装との互換性を維持
  - _Requirements: 1.1, 8.1_

- [x] 4. API層拡張の実装
- [x] 4.1 POST /submissions/{submission_id}/files エンドポイントの実装
  - ファイルアップロードとAddSubmissionFileユースケースの統合
  - 認証・バリデーション・エラーハンドリングを実装
  - レスポンス形式の統一（ファイル名・サイズ返却）
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8_

- [x] 4.2 GET /submissions/{submission_id}/files エンドポイントの実装
  - GetSubmissionFilesユースケースとの統合
  - 認証・権限チェック・エラーハンドリングを実装
  - ファイル一覧とメタデータのJSONレスポンス返却
  - _Requirements: 8.1, 8.2, 8.3, 8.4_

- [x] 4.3 POST /submissions エンドポイントの拡張
  - 単一ファイルでのsubmission作成に対応
  - entrypoint・config_fileのデフォルト値設定を追加
  - 既存の一括アップロードとの互換性を維持
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 5. UI層拡張の実装
- [x] 5.1 Streamlit UIの順次アップロード機能実装
  - 複数ファイルの順次アップロード処理を実装
  - アップロード進捗表示（ファイル数・成功/失敗状態）を追加
  - エラーハンドリングと自動リトライ（最大3回）を実装
  - 全ファイル完了後のジョブ投入ボタン有効化
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 4.1, 4.2, 4.3, 4.4, 6.1, 6.2, 6.3, 6.4_

- [ ] 6. 統合テストの実装
- [x] 6.1 順次アップロードの統合テスト
  - 複数ファイルの順次アップロードE2Eテストを実装
  - ファイル検証・エラーハンドリング・リトライのテストを追加
  - 全ファイル完了後のジョブ投入テストを実装
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3, 5.4, 6.1, 6.2, 6.3, 6.4_

- [ ] 6.2 後方互換性テスト
  - 既存の一括アップロード機能の維持を確認
  - 新機能と既存機能の並行動作テストを実装
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [ ] 6.3 APIエンドポイントの統合テスト
  - 新規APIエンドポイントの完全なテストスイートを実装
  - 認証・権限・バリデーション・エラーハンドリングをテスト
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 8.1, 8.2, 8.3, 8.4_

- [ ] 7. 単体テストの実装
- [ ] 7.1 ドメイン層の単体テスト
  - AddSubmissionFile・GetSubmissionFiles・EnqueueJob拡張のテストを実装
  - モックアダプタを使用した境界ケーステストを追加
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 5.1, 5.2, 5.3, 5.4, 8.1, 8.2, 8.3, 8.4_

- [ ] 7.2 アダプタ層の単体テスト
  - FileSystemStorageAdapter拡張のテストを実装
  - ファイル操作・メタデータ更新・エラーハンドリングをテスト
  - _Requirements: 1.1, 8.1_

- [ ] 7.3 API層の単体テスト
  - 新規APIエンドポイントのテストを実装
  - 既存エンドポイント拡張のテストを追加
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 2.1, 2.2, 2.3, 2.4, 8.1, 8.2, 8.3, 8.4_

## 要件カバレッジ確認

全8要件（32個の受け入れ基準）のうち、以下の要件が実装タスクに完全マッピングされています：

- 要件1: ファイル追加API（1.1-1.8）- タスク1.1, 4.1, 6.1, 6.3, 7.1, 7.3
- 要件2: submission初期化変更（2.1-2.4）- タスク4.3, 6.1, 7.3
- 要件3: UI順次アップロード（3.1-3.6）- タスク5.1
- 要件4: ジョブ投入遅延（4.1-4.4）- タスク5.1
- 要件5: submission完全性検証（5.1-5.4）- タスク1.3, 6.1, 7.1
- 要件6: エラーハンドリングとリトライ（6.1-6.4）- タスク5.1
- 要件7: 後方互換性維持（7.1-7.4）- タスク6.2
- 要件8: ファイル一覧取得（8.1-8.4）- タスク1.2, 4.2, 6.3, 7.1, 7.3

## 並列実行可能なタスク

以下のタスクは他のタスクに依存せず並列実行可能です：

- 1.1 (P): ドメイン層のAddSubmissionFile実装
- 1.2 (P): ドメイン層のGetSubmissionFiles実装
- 7.1 (P): 単体テストの実装（ドメイン層）
- 7.2 (P): 単体テストの実装（アダプタ層）

## 実装順序の依存関係

1. ドメイン層拡張（1.1-1.3）は他の層より先に実装
2. ポート層拡張（2.1）はドメイン層拡張より先に実装
3. アダプタ層拡張（3.1）はポート層拡張より後に実装
4. API層拡張（4.1-4.3）はドメイン・ポート・アダプタ層拡張より後に実装
5. UI層拡張（5.1）はAPI層拡張より後に実装
6. 統合テスト（6.1-6.3）は全実装完了後に実行
7. 単体テスト（7.1-7.3）は対応する実装と並行して実装可能
