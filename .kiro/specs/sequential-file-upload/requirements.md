# 要件定義書

<!-- markdownlint-disable MD024 -->

## プロジェクト説明

ファイルを1つずつ順次アップロード（1ファイル1リクエスト）し、全ファイルのアップロード完了後にジョブを投入する

## 概要

現在のLeadersBoardシステムは、複数ファイルを1つのHTTPリクエストでまとめて送信する方式です。
しかし、ネットワークに1リクエスト当たり100MBの制限がある環境では、
ファイルの合計サイズが制限を超えるとアップロードが失敗してしまいます。
本機能では、ファイルを1つずつ順次アップロードし、全ファイルのアップロード完了後にジョブを投入することで、
100MB制限を回避します。

## 要件

### 要件1: ファイル追加APIの新設

**目的:** 既存のsubmissionに対してファイルを追加アップロードできるようにする。
これにより、100MB制限を回避しながら複数ファイルを送信できる。

#### 受け入れ基準

1. `POST /submissions/{submission_id}/files`を呼び出すと、指定されたsubmissionに1ファイルが追加される
2. submission_idが存在しない場合は、404エラーを返す
3. 追加ファイルのサイズが100MB以下であることを検証する
4. 追加ファイルの拡張子が許可リスト（`.py`, `.yaml`, `.zip`, `.tar.gz`）に含まれることを検証する
5. ファイル検証に失敗した場合は、400エラーと詳細メッセージを返す
6. ファイル名にパストラバーサル（`..`や`/`）が含まれている場合は拒否する
7. 認証トークン（`Authorization: Bearer <token>`）による認証を必須とする
8. ファイル追加が成功した場合は、201ステータスコードとファイル名を含むレスポンスを返す

### 要件2: submission初期化の変更

**目的:** 最初のファイルでsubmissionを作成し、後から追加ファイルをアップロードできるようにする。
これにより、ファイルを分割してアップロードできる。

#### 受け入れ基準

1. `POST /submissions`を1ファイルで呼び出すと、submission_idを生成して返す
2. 最初のファイルがentrypointまたはconfig_fileとして指定されていることを検証する
3. submission作成時にentrypointとconfig_fileの両方が指定されていない場合は、
   デフォルト値（entrypoint: `main.py`, config_file: `config.yaml`）を使用する
4. submission作成時点では、entrypointとconfig_fileに対応するファイルの存在確認を遅延させる（全ファイルアップロード完了まで猶予を与える）

### 要件3: Streamlit UIの順次アップロード

**目的:** Streamlit UIから複数ファイルを順次アップロードできるようにする。
これにより、各ファイルが100MB以下であれば送信できる。

#### 受け入れ基準

1. 複数ファイルがアップロードされた場合、各ファイルを個別のリクエストで順次送信する
2. 最初のファイルで`POST /submissions`を呼び出し、submission_idを取得する
3. ファイルアップロード中は、進捗表示（例: "2/5 ファイルをアップロード中..."）を表示する
4. 2番目以降のファイルは、`POST /submissions/{submission_id}/files`で送信する
5. いずれかのファイルアップロードが失敗した場合は、エラーメッセージを表示し、後続ファイルの送信を中止する
6. 全ファイルのアップロードが完了したら、成功メッセージと送信完了したファイル数を表示する

### 要件4: ジョブ投入の遅延実行

**目的:** 全ファイルのアップロード完了後にジョブを投入できるようにする。
これにより、Workerが不完全なファイルセットで実行を開始することを防ぐ。

#### 受け入れ基準

1. 全ファイルのアップロードが完了したら、`POST /jobs`を呼び出してジョブを投入する
2. ファイルアップロード中は、ジョブ投入ボタンを無効化する
3. ファイルアップロード完了前にユーザーがページを離れた場合は、アップロード中断を検知し警告を表示する（オプション）
4. ジョブ投入が成功したら、job_idを表示しジョブ一覧に追加する

### 要件5: submission完全性の検証

**目的:** ジョブ投入時にsubmissionの完全性を検証できるようにする。
これにより、不完全なファイルセットで実行が開始されることを防ぐ。

#### 受け入れ基準

1. `POST /jobs`が呼び出された際、指定されたsubmissionにentrypointファイルが存在することを検証する
2. `POST /jobs`が呼び出された際、指定されたsubmissionにconfig_fileが存在することを検証する
3. 必須ファイルが存在しない場合は、400エラーと不足ファイル名を含むメッセージを返す
4. ジョブ投入前にsubmissionメタデータを読み込み、entrypointとconfig_fileのパスを確認する

### 要件6: エラーハンドリングとリトライ

**目的:** ファイルアップロード失敗時に自動リトライできるようにする。
これにより、一時的なネットワークエラーで全体が失敗することを防ぐ。

#### 受け入れ基準

1. 個別ファイルアップロードが5xxエラーで失敗した場合は、最大3回まで自動リトライする
2. リトライが全て失敗した場合は、エラーメッセージと失敗したファイル名を表示する
3. リトライ中は進捗表示（例: "再試行中... (2/3)"）を表示する
4. 4xxエラー（バリデーションエラー）が発生した場合は、リトライせずにエラーメッセージを表示する

### 要件7: 後方互換性の維持

**目的:** 既存の一括アップロード方式も引き続き使用できるようにする。
これにより、既存のクライアントが動作し続ける。

#### 受け入れ基準

1. 既存の`POST /submissions`（複数ファイル一括）を引き続きサポートする
2. 複数ファイルが1リクエストで送信された場合は、従来通りすべてのファイルを一度に保存する
3. 一括アップロードと順次アップロードの両方で同じメタデータ形式を使用する
4. 順次アップロードで作成されたsubmissionと一括アップロードで作成されたsubmissionを同じ方法で処理する

### 要件8: ファイル一覧の取得

**目的:** アップロード済みファイルの一覧を確認できるようにする。
これにより、どのファイルが送信済みかを確認できる。

#### 受け入れ基準

1. `GET /submissions/{submission_id}/files`を呼び出すと、アップロード済みファイル名のリストを返す
2. ファイル一覧には、各ファイルのサイズとアップロード日時を含める
3. submission_idが存在しない場合は、404エラーを返す
4. 認証済みユーザー自身のsubmissionのみアクセスを許可する
