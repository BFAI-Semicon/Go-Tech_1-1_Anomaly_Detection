# Implementation Plan

## Task Overview

本実装計画は、Streamlit UIでworkerプロセスのログをリアルタイムに表示する機能を実現するためのタスクを定義する。

**修正対象コンポーネント**:

- Worker層: `JobWorker` - リアルタイムログ出力
- アダプタ層: `FileSystemStorageAdapter` - tail処理追加
- API層: `JobsLogsEndpoint` - エラーハンドリング改善
- UI層: `StreamlitLogDisplay` - ログ表示コンポーネント追加

## Tasks

- [ ] 1. Workerリアルタイムログ出力機能の実装
- [ ] 1.1 (P) サブプロセス実行をPopenベースに変更
  - ジョブ実行時に`subprocess.run()`から`subprocess.Popen()`に変更する
  - stdout/stderrをログファイルに直接ストリーミングする
  - ジョブ開始時にログファイルを作成し、APIからの早期アクセスを可能にする
  - `PYTHONUNBUFFERED=1`環境変数でバッファリングを最小化する
  - _Requirements: 2.1, 2.2, 2.3_

- [ ] 1.2 タイムアウトとエラー処理の実装
  - `process.wait(timeout=...)`でタイムアウト処理を実装する
  - タイムアウト発生時もログファイルを保持し、エラー情報を追記する
  - サブプロセス異常終了時にstderrをログに出力してからステータスを更新する
  - 既存の`_save_job_log()`メソッドを削除し、実行中に直接ログ出力に変更する
  - _Requirements: 2.4, 2.5, 6.2_

- [ ] 1.3 Workerユニットテストの追加
  - Popenでログがリアルタイム出力されることを検証するテストを追加する
  - タイムアウト時のログ保持を検証するテストを追加する
  - 異常終了時のエラーログ出力を検証するテストを追加する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 2. ストレージアダプタのtail処理追加
- [ ] 2.1 (P) load_logsメソッドにtail機能を追加
  - `load_logs()`メソッドにオプションの`tail_lines`パラメータを追加する
  - 大きなログファイルの最後のN行のみを返す機能を実装する
  - メモリ使用量を抑制しながらファイル読み取りを行う
  - ファイルが存在しない場合の既存動作（`FileNotFoundError`）を維持する
  - _Requirements: 3.3, 6.5_

- [ ] 2.2 アダプタユニットテストの追加
  - tail処理が正しく動作することを検証するテストを追加する
  - 大きなファイル（1000行超）のtail処理を検証するテストを追加する
  - _Requirements: 3.3, 6.5_

- [ ] 3. APIログ取得エンドポイントの改善
- [ ] 3.1 エラーハンドリングの追加
  - ログファイルが存在しない場合に空文字列を返すように変更する（404ではなく）
  - `FileNotFoundError`をtry-exceptでキャッチして適切に処理する
  - ログ取得エラーをFastAPIログに記録する
  - 認証トークン検証は既存の動作を維持する
  - _Requirements: 3.1, 3.2, 3.4, 3.5, 7.1, 7.2_

- [ ] 3.2 大きなログファイルのtail処理適用
  - ログファイルが1000行を超える場合に最後の1000行のみを返すように変更する
  - アダプタの`load_logs(tail_lines=1000)`を呼び出す
  - _Requirements: 3.3, 6.5_

- [ ] 3.3 APIユニットテストの追加
  - ファイル未存在時に空文字列を返すことを検証するテストを追加する
  - 大きなファイルのtail処理を検証するテストを追加する
  - 認証失敗時の401レスポンスを検証するテストを追加する
  - _Requirements: 3.1, 3.2, 3.3, 7.1, 7.2_

- [ ] 4. Streamlit UIログ表示コンポーネントの実装
- [ ] 4.1 実行中ジョブのログ表示フィールド追加
  - 実行中（`running`）ジョブにログ表示フィールドを追加する
  - ログ表示フィールドを展開状態で表示し、最新ログを表示する
  - `pending`状態のジョブにも「ログはまだありません」メッセージを表示する
  - ログ表示フィールドに十分な高さ（400px）を確保する
  - 等幅フォントでログを表示し、整形を維持する
  - _Requirements: 1.1, 1.2, 1.4, 1.5, 5.1, 5.3_

- [ ] 4.2 自動更新でのログ取得追加
  - 既存の5秒ごとの自動更新サイクルにログ取得を追加する
  - 実行中ジョブがある場合のみログを自動取得する
  - 「自動更新中...」のインジケータを表示する
  - ログ取得失敗時は最後に取得したログを保持しエラーメッセージを表示する
  - ジョブ完了時は自動更新を停止し、最終ログを表示する
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 6.4_

- [ ] 4.3 完了ジョブのログ表示改善
  - 完了（`completed`/`failed`）ジョブのログ表示をExpander内に維持する
  - 既存の動作との整合性を確保する
  - _Requirements: 1.3_

- [ ] 4.4 手動更新ボタンの追加
  - ユーザーが任意のタイミングでログを再取得できる手動更新ボタンを追加する
  - ボタンクリック時にログを即座に再取得して表示を更新する
  - _Requirements: 5.5_

- [ ] 4.5 Streamlit UIユニットテストの追加
  - 実行中ジョブのログ表示を検証するテストを追加する
  - 自動更新でログが取得されることを検証するテストを追加する
  - 手動更新ボタンの動作を検証するテストを追加する
  - _Requirements: 1.1, 1.2, 4.1, 5.5_

- [ ] 5. 統合テストとE2Eテストの実装
- [ ] 5.1 統合テストの追加
  - ジョブ実行中にAPIでログが取得可能であることを検証する
  - 実行中にログが更新されることを検証する
  - Worker→API→UIの連携を検証する
  - _Requirements: 2.1, 2.2, 3.1, 4.1_

- [ ] 5.2* E2Eテストの追加（オプション）
  - 実行中ジョブでログ表示フィールドが表示されることを確認する
  - 5秒ごとにログが更新されることを確認する
  - 手動更新ボタンが機能することを確認する
  - _Requirements: 1.1, 1.2, 4.1, 4.3, 5.5_

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 | 4.1, 4.5, 5.2 |
| 1.2 | 4.1, 4.5, 5.2 |
| 1.3 | 4.3 |
| 1.4 | 4.1 |
| 1.5 | 4.1 |
| 2.1 | 1.1, 1.3, 5.1 |
| 2.2 | 1.1, 1.3, 5.1 |
| 2.3 | 1.1, 1.3 |
| 2.4 | 1.2, 1.3 |
| 2.5 | 1.2, 1.3 |
| 3.1 | 3.1, 3.3, 5.1 |
| 3.2 | 3.1, 3.3 |
| 3.3 | 2.1, 2.2, 3.2, 3.3 |
| 3.4 | 3.1 |
| 3.5 | 3.1 |
| 4.1 | 4.2, 4.5, 5.1, 5.2 |
| 4.2 | 4.2 |
| 4.3 | 4.2, 5.2 |
| 4.4 | 4.2 |
| 4.5 | 4.2 |
| 5.1 | 4.1 |
| 5.2 | - (自動スクロールはStreamlitの制限により部分対応) |
| 5.3 | 4.1 |
| 5.4 | - (エラーハイライトは将来の拡張として検討) |
| 5.5 | 4.4, 4.5, 5.2 |
| 6.1 | - (既存のレート制限を維持) |
| 6.2 | 1.2 |
| 6.3 | - (既存のセッション管理を維持) |
| 6.4 | 4.2 |
| 6.5 | 2.1, 2.2, 3.2 |
| 7.1 | 3.1, 3.3 |
| 7.2 | 3.1, 3.3 |
| 7.3 | - (将来の拡張として検討) |
| 7.4 | - (既存のトークン管理を維持) |
| 7.5 | - (将来の拡張として検討) |

## Deferred Requirements

以下の要件は将来の拡張として延期:

- **5.2**: 自動スクロール - Streamlitの`st.text_area`では自動スクロールの直接制御が困難
- **5.4**: エラーログのハイライト表示 - 追加のUI実装が必要、MVP後に検討
- **7.3**: ジョブ所有者検証 - 現在の認証モデルでは全ユーザーが全ログにアクセス可能
- **7.5**: ログ内容のフィルタリング - 機密情報検出の実装が複雑、将来検討

## Parallel Execution Notes

以下のタスクは並列実行可能:

- **1.1 (P)** と **2.1 (P)**: Worker変更とアダプタ変更は独立したファイルを修正するため並列可能
- タスク3以降は依存関係があるため順次実行が必要
